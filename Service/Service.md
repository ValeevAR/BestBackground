# Реализация сервиса с моделью

В этой секции приведены:
1. Код сервиса
2. Файл с инструкцией по запуску и эксплуатации
3. Dockerfile для запуска сервера-сервиса

 # Код

 Основная работа кода выполняется в service.py, где описаны все методы для преобразования изображений, инициализация моделей, и логика обработки различных типовы входных данных.

 Блок app.py описывает бэкенд-составляющую сервиса: логику обработки запросов и вывод.

 Блок client.py описывает базовый API взаимодействия пользователя с сервисом посредством отправления ссылок или локальных файлов на обработку.

 # Как пользоваться

 Для запуска сервиса необходимо склонировать себе этот репозиторий или содержимое папки Service и перейти в директорию с Dockerfile.

 ```bash
 git clone https://github.com/ValeevAR/BestBackground.git
 ```

 Затем нужно перейти в папку Service внутри папки репозитория

 ```bash
 cd <путь к папке репозитория>/BestBackground/Service
 ```

 Далее запустить команду создания Docker-образа:

```bash
docker build -t app:0.0.1 .
```

После завершения установки можно запустить сервис для работы командой\
Для работы с CPU:

```bash
docker run -d -p 8080:8080 app:0.0.1
```

Для работы с GPU:
```bash
docker run -d -p 8080:8080 --gpus <название GPU или all для использования всех> app:0.0.1
```
Обратите внимание, что в данной инструкции предполагается, что настройка машины для работы с GPU уже проведена, то есть установлен nvidia-cuda-toolkit и сама машина оснащена нужным оборудованием.

Также обратите внимание, что контейнер с флагом "-d" запускается в detached режиме, то есть вывод в консоль о работе не производится. Для проверки логов работы см. раздел Отслеживание работы сервиса.

Если установка произошла успешно, то у пользователя появится доступ к серверу в локальной сети по адресу http://127.0.0.1:8080.

Проверить, что сервер запущен, можно отправив запрос http://127.0.0.1:8080/health извне Докер-контейнера во внешней машине

```bash
curl http://127.0.0.1:8080/health
```

Или отправить аналогичный запрос изнутри Докер-контейнера:

Для этого надо зайти в контейнер и запустить bash в интерактивном режиме:

Найти id запущенного докер-контейнера:

```bash
docker ps
```

Запустить bash в интерактивном режиме внутри контейнера:

```bash
docker exec -it <id контейнера> bash
```

В bash-консоли внутри докер-контейнера указать желаемую команду для проверки:

```bash
curl http://127.0.0.1:8080/health
```

Для выхода из консоли внутри докер-контейнера можно использовать команду 

```bash
exit
```

Результатом любого из данных curl запросов должен быть json с единственным элементом {'result': True}.

# Отслеживание работы сервиса

Для проверки логов сервиса внутри контейнера нужно узнать его id командой

```bash
docker ps
```

Найти там ID запущенного контейнер с заданным тэгом app:0.0.1 (или другим, который задавался командой docker build после -t).

Теперь для перехода в режим мониторинга логов нужно использовать команду

```bash
docker logs -f <id контейнера>
```

Для выхода из этого режима достаточно нажать Ctrl+C, сам контейнер останется работать в штатном режиме.

Для остановки работы сервиса нужно остановить контейнер:

```bash
docker stop <id контейнера>
```

# Проверка работы
Основной функционал сервиса реализован в виде отправки серверу POST запросов с json, содержащим инфомрацию об изображении и режиме обработки.

Для проверки полноценной работы сервиса с инференсом модели можно отправить POST запрос со специальными параметрами на <ip_address>:8080/process. В случае локальной проверки работы ip_addres = http://127.0.0.1, для других примеров см. ниже:

```bash
curl -D - -X POST \
-H "Content-Type: application/json" \
-d '{"url":"https://shorturl.at/yzLW9","mode":"crop"}' \
-o /dev/null \
http://127.0.0.1:8080/process
```

Аналогично с прошлым запросом, curl запрос можно выполнить как извне контейнера на внешней машине, так и внутри контейнера.

Для этого выполнить те же действия по запуску bash внутри контейнера, а затем поменять команду на представленную выше.

Для удобства проверки в примере curl запроса уже указан пример ссылки на изображения режима обработки, но оба этих параметра можно заменить на нужные пользователю.

**url** -- прямая ссылка на изображение, например, https://10.img.avito.st/image/1/1.4DTkPra4TN3Sl47YqEHtZ8CcTttan87VkppO31SXRNdS.YfEfKm4HGY0h-kbatD2aQ6hpmF7pUEPFQIvetUMVDk0

**mode** -- режим обработки, может быть crop, blur или both.

Посмотреть сами изображения, над которыми сервис осуществляет инференс можно в Jupyter-notebook [test.ipynb](test.ipynb) в директории Service репозитория.

Там же показан базовый вариант использования бэкенда для клиентского интерфейса в виде отдельного класса Client.

Обратите внимание, что для запуска ноутбука на локальной машине предполагается наличие установленного Python и среды для работы с ноутбуками.
Для удобства использования мы используем две виртуальные машины с уже запущенным сервисом:\
С CPU по адресу http://51.250.93.34:8080/ \
C GPU по адресу http://158.160.60.11:8080/ 

Оба эти сервера можно использовать в качестве аргумента вместо ip локальной машины в curl запросе, для класса Client и нагрузочного тестирования, описанного ниже. 

Обратите внимание, что инференс модели осуществляется именно по адресу с **/process** в конце. Для работы внутри клиентского интерфейса или в ноутбуках достаточно указать сам адрес в заданные агрументы, но для отправки curl-запроса нужно добавлять аргумент /process, например http://158.160.60.11:8080/process.

# Нагрузочное тестирование

Помимо прочего, в репозитории хранится скрипт для нагрузочного тестирования сервиса на машине. Для его использования необходимо установить locust.

```bash
pip install locust
```

Для запуска сервера нагрузочного тестирования нужно из директории Service вызвать locust командой:

```bash
locust --web-host 127.0.0.1
```
Для работы с locust используется собственный класс, имитирующий запросы пользователей. Информация о нем в файле [locustfile.py](locustfile.py).

При вводе команды автоматически запустится локальный сервер на порте 8089.

Для использования сервиса нужно в браузере перейти по адресу

http://localhost:8089 или http://127.0.0.1:8089

Далее можно в интерфейса задать нагрузку на сервер и следить за его работой в реальном времени.

Для выбора сервера для тестирования необходимо в окно ссылки на сервер указать адрес в формате:

http://<server_ip>:8080/

где server_ip задается как:

127.0.0.1 для локально поднятного сервиса \
51.250.93.34 для сервиса с CPU
158.160.60.11 для сервиса с GPU

Обратите внимание, что в рамках работы сервиса есть ситуации, когда объект не был найден на изображении, при этом ожидаемым поведением является выброс исключения с соответствующим сообщением. Некоторые из изображений в тестовом наборе вызывают это исключение, что и является причиной небольшого процента failures при нагрузочном тестировании.