# Реализация сервиса с моделью

В этой секции приведены:
1. Код сервиса
2. Файл с инструкцией по запуску и эксплуатации
3. Dockerfile для запуска сервера-сервиса

 # Код

 Основная работа кода выполняется в service.py, где описаны все методы для преобразования изображений, инициализация моделей, и логика обработки различных типовы входных данных.

 Блок app.py описывает бэкенд-составляющую сервиса: логику обработки запросов и вывод.

 Блок client.py описывает базовый API взаимодействия пользователя с сервисом посредством отправления ссылок или локальных файлов на обработку.

 # Как пользоваться

 Для запуска сервиса необходимо склонировать себе этот репозиторий или содержимое папки Service и перейти в директорию с Dockerfile.

 ```bash
 git clone https://github.com/ValeevAR/BestBackground.git
 ```

 Затем нужно перейти в папку Service внутри папки репозитория

 ```bash
 cd <путь к папке репозитория>/BestBackground/Service
 ```

 Далее запустить команду создания Docker-образа:

```bash
docker build -t app:0.0.1 .
```

После завершения установки можно запустить сервис для работы командой\
Для работы с CPU:

```bash
docker run -d -p 8080:8080 app:0.0.1
```

Для работы с GPU:
```bash
docker run -d -p 8080:8080 --gpus <название GPU или all для использования всех> app:0.0.1
```
Обратите внимание, что в данной инструкции предполагается, что настройка машины для работы с GPU уже проведена, то есть установлен nvidia-cuda-toolkit и сама машина оснащена нужным оборудованием.

Если установка произошла успешно, то у пользователя появится доступ к серверу в локальной сети по адресу http://127.0.0.1:8080.

Проверить, что сервер запущен, можно отправив запрос http://127.0.0.1:8080/health.

```bash
curl http://127.0.0.1:8080/health
```
Результатом должен быть json с единственным элементом {'result': True}.

# Отслеживание работы сервера

Обратите внимание, что контейнер с флагом "-d" запускается в detached режиме.

Для проверки логов сервера внутри контейнера нужно узнать его id командой

```bash
docker ps
```

Найти там ID запущенного контейнер с заданным тэгом app:0.0.1 (или другим, который задавался командой docker build после -t).

Теперь для перехода в режим мониторинга логов нужно использовать команду

```bash
docker logs -f <id контейнера>
```

Для выхода из этого режима достаточно нажать Ctrl+C, сам контейнер останется работать в штатном режиме.

Для остановки работы сервиса нужно остановить контейнер:

```bash
docker stop <id контейнера>
```

# Проверка работы

Проверить, что сервис осуществляет инференс моделей можно в Jupyter-notebook [test.ipynb](test.ipynb) в директории Service репозитория. \
Там же показан базовый вариант использования бэкенда для клиентского интерфейса в виде отдельного класса Client. \
Обратите внимание, что для запуска файла на локальной машине предполагается наличие установленного Python и среды для работы с ноутбуками.
# Нагрузочное тестирование

Помимо прочего, в репозитории хранится скрипт для нагрузочного тестирования сервиса на машине. Для его использования необходимо установить locust.

```bash
pip install locust
```

Для запуска сервера нагрузочного тестирования нужно из директории Service вызвать locust командой:

```bash
locust
```
Для работы с locust используется собственный класс, имитирующий запросы пользователей. Информация о нем в файле [locustfile.py](locustfile.py).

При вводе команды автоматически запустится локальный сервер на порте 8089.

Для использования сервиса нужно в браузере перейти по адресу

http://localhost:8089 или http://127.0.0.1:8089

Далее можно в интерфейса задать нагрузку на сервер и следить за его работой в реальном времени.